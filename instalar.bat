@echo off
chcp 65001 > nul
setlocal enabledelayedexpansion

:: Contadores de estado
set "SUCCESS_COUNT=0"
set "FAIL_COUNT=0"

:: Configurar directorio de trabajo
set "SCRIPT_DIR=%~dp0"
cd /d "%SCRIPT_DIR%"

:: Forzar cache y temporales en este directorio (evitar C: y falta de espacio)
if not exist "pip-cache" mkdir "pip-cache" 2>nul
if not exist "temp" mkdir "temp" 2>nul
set "PIP_CACHE_DIR=%CD%\pip-cache"
set "TMP=%CD%\temp"
set "TEMP=%CD%\temp"
set "PIP_NO_INPUT=1"

echo.
echo ============================================================
echo üéôÔ∏è VoiceClone AI Spanish - Instalaci√≥n Ultra Robusta
echo ============================================================
echo üìÅ Directorio de trabajo: %CD%
echo.

:: Verificar si Python est√° instalado y es versi√≥n 3.11.8 espec√≠fica
echo [1/8] üêç Verificando Python 3.11.8...
python --version >nul 2>&1
if %ERRORLEVEL% neq 0 (
    echo ‚ùå Error: Python no est√° instalado o no est√° en PATH
    echo.
    echo üí° Descargar Python 3.11.8 desde: https://www.python.org/downloads/release/python-3118/
    echo    ‚úÖ Aseg√∫rate de marcar "Add Python to PATH"
    echo    üî• CR√çTICO: Usar Python 3.11.8 para compatibilidad F5-TTS + PyTorch CUDA
    pause
    exit /b 1
)

:: Verificar versi√≥n espec√≠fica de Python
for /f "tokens=2" %%v in ('python --version 2^>^&1') do set "PYTHON_VERSION=%%v"
echo üîç Python %PYTHON_VERSION% detectado

:: Extraer versi√≥n completa (mayor.menor.patch)
for /f "tokens=1 delims=." %%a in ("%PYTHON_VERSION%") do set "PYTHON_MAJOR=%%a"
for /f "tokens=2 delims=." %%b in ("%PYTHON_VERSION%") do set "PYTHON_MINOR=%%b"
for /f "tokens=3 delims=." %%c in ("%PYTHON_VERSION%") do set "PYTHON_PATCH=%%c"

if not "%PYTHON_MAJOR%"=="3" (
    echo ‚ùå Error: Se requiere Python 3.x
    echo üí° Instala Python 3.11.8 para m√°xima compatibilidad
    pause
    exit /b 1
)

if not "%PYTHON_MINOR%"=="11" (
    echo ‚ùå ERROR: Python 3.11 requerido para F5-TTS
    echo    Versi√≥n actual: %PYTHON_VERSION%
    echo    Versi√≥n requerida: 3.11.8
    echo.
    echo üî• F5-TTS requiere Python 3.11 espec√≠ficamente
    echo    PyTorch CUDA tambi√©n funciona mejor con 3.11
    echo.
    echo üì• DESCARGAR Python 3.11.8:
    echo    https://www.python.org/downloads/release/python-3118/
    echo.
    pause
    exit /b 1
)

:: Solo advertir si NO es Python 3.11.x
for /f "tokens=1,2 delims=." %%a in ("%PYTHON_VERSION%") do (
    set "PYTHON_MAJOR_MINOR=%%a.%%b"
)

if not "%PYTHON_MAJOR_MINOR%"=="3.11" (
    echo ‚ùå ERROR: Python 3.11 requerido para F5-TTS
    echo    Versi√≥n actual: %PYTHON_VERSION%
    echo    Versi√≥n requerida: 3.11.x
    echo.
    echo üì• DESCARGAR Python 3.11.8:
    echo    https://www.python.org/downloads/release/python-3118/
    echo.
    pause
    exit /b 1
) else (
    echo ‚úÖ Python %PYTHON_VERSION% detectado - COMPATIBLE con F5-TTS
)

:: Crear entorno virtual si no existe
echo.
echo [2/8] üèóÔ∏è Configurando entorno virtual...
if not exist "venv" (
    echo üîß Creando entorno virtual...
    python -m venv venv
    if %ERRORLEVEL% neq 0 (
        echo ‚ùå Error creando entorno virtual
        pause
        exit /b 1
    )
) else (
    echo ‚úÖ Entorno virtual ya existe
)

:: Activar el entorno virtual
echo.
echo üöÄ Activando entorno virtual...
call "venv\Scripts\activate.bat" >nul 2>&1
if errorlevel 1 (
    echo ‚ö†Ô∏è No se pudo activar el entorno virtual. Continuando con Python actual...
) else (
    echo ‚úÖ Entorno virtual activado
)

:: Dependencias base
echo.
echo [3/8] ÔøΩ Instalando dependencias base...
python -m pip install --upgrade pip setuptools wheel
python -m pip install "gradio>=4.0.0" "transformers>=4.30.0" "huggingface-hub>=0.15.0"
python -c "import gradio, transformers, huggingface_hub; print('BASE_OK')" >nul 2>&1
if %ERRORLEVEL% equ 0 (
    echo ‚úÖ Dependencias base instaladas
    set /a SUCCESS_COUNT+=1
) else (
    echo ‚ùå Error instalando dependencias base
    set /a FAIL_COUNT+=1
)

:: Librer√≠as b√°sicas de audio/ciencia
echo.
echo [4/8] ÔøΩÔ∏è Instalando librer√≠as b√°sicas de audio/ciencia...
python -m pip install numpy pandas pyyaml tqdm soundfile pydub --quiet
python -c "import numpy, pandas, yaml, tqdm, soundfile, pydub; print('CORE_OK')" >nul 2>&1
if %ERRORLEVEL% equ 0 (
    echo ‚úÖ Librer√≠as b√°sicas instaladas
    set /a SUCCESS_COUNT+=1
) else (
    echo ‚ö†Ô∏è Algunas librer√≠as b√°sicas fallaron
    set /a FAIL_COUNT+=1
)

:: Intentar instalar PyTorch (versi√≥n m√°s robusta y espec√≠fica)
echo.
echo [5/8] üî• Instalando PyTorch optimizado para Python %PYTHON_VERSION%...

:: Limpiar instalaciones previas de PyTorch
echo üßπ Limpiando instalaciones previas de PyTorch...
python -m pip uninstall -y torch torchvision torchaudio --quiet 2>nul

:: Verificar si tenemos Python 3.11 para CUDA √≥ptimo
if "%PYTHON_MINOR%"=="11" (
    echo üöÄ Python 3.11 detectado - Instalando PyTorch CUDA optimizado...
    echo    üì• Descargando PyTorch CUDA 12.1 para Python 3.11...
    python -m pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
    
    :: Verificar instalaci√≥n CUDA
    python -c "import torch; print('‚úÖ PyTorch CUDA:', torch.version.cuda if torch.cuda.is_available() else 'No disponible')" 2>nul
    if %ERRORLEVEL% equ 0 (
        python -c "import torch; exit(0 if torch.cuda.is_available() else 1)" 2>nul
        if %ERRORLEVEL% equ 0 (
            echo    ‚úÖ PyTorch CUDA instalado y GPU detectada
            set /a SUCCESS_COUNT+=1
        ) else (
            echo    ‚ö†Ô∏è PyTorch CUDA instalado pero GPU no detectada
            echo       üí° Verifica drivers NVIDIA y CUDA Toolkit 12.1
            set /a SUCCESS_COUNT+=1
        )
    ) else (
        goto :fallback_cpu_pytorch
    )
) else (
    echo üîÑ Python %PYTHON_VERSION% - Probando PyTorch CUDA...
    python -m pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
    python -c "import torch; print('PYTORCH_OK')" >nul 2>&1
    if %ERRORLEVEL% equ 0 (
        python -c "import torch; exit(0 if torch.cuda.is_available() else 1)" 2>nul
        if %ERRORLEVEL% equ 0 (
            echo    ‚úÖ PyTorch CUDA funcionando con Python %PYTHON_VERSION%
            set /a SUCCESS_COUNT+=1
        ) else (
            echo    ‚ö†Ô∏è PyTorch instalado sin CUDA para Python %PYTHON_VERSION%
            set /a SUCCESS_COUNT+=1
        )
    ) else (
        goto :fallback_cpu_pytorch
    )
)
goto :pytorch_done

:fallback_cpu_pytorch
echo    ‚ö†Ô∏è PyTorch CUDA fall√≥, instalando versi√≥n CPU...
python -m pip install --no-cache-dir torch torchvision torchaudio
python -c "import torch; print('PYTORCH_OK')" >nul 2>&1
if %ERRORLEVEL% equ 0 (
    echo    ‚úÖ PyTorch CPU instalado y funcional
    set /a SUCCESS_COUNT+=1
) else (
    echo    ‚ùå PyTorch no se pudo instalar
    set /a FAIL_COUNT+=1
)

:pytorch_done

:: Verificar herramientas de compilaci√≥n
echo.
echo [6/8] üîç Verificando herramientas de compilaci√≥n (ninja/meson/MSVC)...
set "BUILD_TOOLS_OK=1"

where ninja >nul 2>&1
if errorlevel 1 (
    echo ‚ö†Ô∏è Ninja no encontrado
    set "BUILD_TOOLS_OK=0"
)
if not errorlevel 1 (
    echo ‚úÖ Ninja encontrado
)

where meson >nul 2>&1
if errorlevel 1 (
    echo ‚ö†Ô∏è Meson no encontrado
    set "BUILD_TOOLS_OK=0"
)
if not errorlevel 1 (
    echo ‚úÖ Meson encontrado
)

where cl >nul 2>&1
if errorlevel 1 (
    echo ‚ö†Ô∏è MSVC (Visual Studio Build Tools) no encontrado
    set "BUILD_TOOLS_OK=0"
)
if not errorlevel 1 (
    echo ‚úÖ MSVC encontrado
)

:: Intentar instalar herramientas m√≠nimas v√≠a pip dentro del venv si faltan
if "!BUILD_TOOLS_OK!"=="0" (
    echo.
    echo üîÑ Intentando instalar herramientas de compilaci√≥n m√≠nimas en el entorno virtual...
    echo    (ninja, meson, cmake, meson-python)
    python -m pip install --upgrade pip setuptools wheel
    python -m pip install ninja meson cmake meson-python

    :: Revalidar disponibilidad tras instalaci√≥n
    set "BUILD_TOOLS_OK=1"
    where ninja >nul 2>&1
    if errorlevel 1 set "BUILD_TOOLS_OK=0"
    where meson >nul 2>&1
    if errorlevel 1 set "BUILD_TOOLS_OK=0"
    where cl >nul 2>&1
    if errorlevel 1 set "BUILD_TOOLS_OK=0"

    if "!BUILD_TOOLS_OK!"=="1" (
        echo ‚úÖ Herramientas m√≠nimas instaladas correctamente
    ) else (
        echo ‚ö†Ô∏è Algunas herramientas siguen faltando (MSVC no se instala con pip)
    )
)

:: Intentar instalar Spanish-F5
echo.
echo [7/8] üá™üá∏ Instalando Spanish-F5...
if "!BUILD_TOOLS_OK!"=="0" (
    echo.
    echo ‚ö†Ô∏è HERRAMIENTAS DE COMPILACI√ìN FALTANTES
    echo ==========================================
    echo Spanish-F5 requiere ninja + meson + MSVC pero faltan herramientas.
    echo.
    echo üõ†Ô∏è Para completar la instalaci√≥n:
    echo    1. Instala Visual Studio Build Tools
    echo       https://visualstudio.microsoft.com/visual-cpp-build-tools/
    echo    2. Selecciona "C++ build tools" durante instalaci√≥n
    echo    3. Reinicia el sistema
    echo    4. Ejecuta este script nuevamente
    echo.
    echo üí° Mientras tanto, puedes usar otras funciones TTS
    echo    ‚ùå Spanish-F5: SALTADO (faltan herramientas)
    set /a FAIL_COUNT+=1
) else (
    echo üîß Herramientas de compilaci√≥n detectadas, instalando Spanish-F5...
    
    :: Limpiar instalaci√≥n previa
    if exist "temp_spanish_f5" (
        echo üßπ Limpiando instalaci√≥n previa...
        rmdir /s /q "temp_spanish_f5" 2>nul
    )
    
    :: Clonar repositorio
    echo üì• Clonando Spanish-F5 desde GitHub...
    git clone https://github.com/jpgallegoar/Spanish-F5.git temp_spanish_f5
    set "_SPANISH_F5_CLONE_ERROR=%ERRORLEVEL%"
    if not "%_SPANISH_F5_CLONE_ERROR%"=="0" (
        echo ‚ùå Error clonando Spanish-F5
        set /a FAIL_COUNT+=1
    ) else (
        :: Instalar Spanish-F5
        echo üèóÔ∏è Compilando e instalando Spanish-F5...
        pushd temp_spanish_f5
        python -m pip install . --quiet
        set "_SPANISH_F5_INSTALL_ERROR=%ERRORLEVEL%"
        popd
        
        :: Verificar que funciona
        if not "%_SPANISH_F5_INSTALL_ERROR%"=="0" (
            echo ‚ùå Spanish-F5 no se pudo instalar
            set /a FAIL_COUNT+=1
        ) else (
            python -c "from spanish_f5 import load_model; print('SPANISH_F5_OK')" >nul 2>&1
            if %ERRORLEVEL% equ 0 (
                echo ‚úÖ Spanish-F5 instalado y funcional
                set /a SUCCESS_COUNT+=1
            ) else (
                echo ‚ùå Spanish-F5 instalado pero no funciona
                set /a FAIL_COUNT+=1
            )
        )
    )
    
    :: Limpiar archivos temporales
    if exist "temp_spanish_f5" (
        echo üßπ Limpiando archivos temporales Spanish-F5...
        rmdir /s /q "temp_spanish_f5" 2>nul
    )
)

:: Instalar F5-TTS (CR√çTICO para funcionamiento)
echo.
echo [7.5/8] üéØ Instalando F5-TTS (Motor principal)...
echo üî• F5-TTS es CR√çTICO para el funcionamiento del sistema

:: Intentar instalaci√≥n directa con pip
echo üì¶ M√©todo 1: Instalaci√≥n directa con pip...
python -m pip install f5-tts
python -c "import f5_tts; print('F5_TTS_OK')" >nul 2>&1
if %ERRORLEVEL% equ 0 (
    echo ‚úÖ F5-TTS instalado exitosamente con pip
    set /a SUCCESS_COUNT+=1
    goto :f5_tts_done
)

echo ‚ö†Ô∏è Pip install fall√≥, probando instalaci√≥n desde c√≥digo fuente...

:: Limpiar instalaci√≥n previa si existe
if exist "temp_f5_tts" (
    echo üßπ Limpiando instalaci√≥n previa de F5-TTS...
    rmdir /s /q "temp_f5_tts" 2>nul
)

:: Clonar repositorio F5-TTS
echo üì• Clonando F5-TTS desde GitHub...
git clone https://github.com/SWivid/F5-TTS.git temp_f5_tts
if %ERRORLEVEL% neq 0 (
    echo ‚ùå Error clonando F5-TTS
    echo üö® F5-TTS es CR√çTICO - sin √©l el sistema no funcionar√°
    set /a FAIL_COUNT+=1
    goto :f5_tts_failed
)

:: Instalar desde c√≥digo fuente
echo üèóÔ∏è Instalando F5-TTS desde c√≥digo fuente...
pushd temp_f5_tts
echo    üìã Instalando en modo desarrollo...
python -m pip install -e .
popd

:: Verificar instalaci√≥n
python -c "import f5_tts; print('F5_TTS_OK')" >nul 2>&1
if %ERRORLEVEL% equ 0 (
    echo ‚úÖ F5-TTS instalado exitosamente desde c√≥digo fuente
    set /a SUCCESS_COUNT+=1
) else (
    echo ‚ùå F5-TTS fall√≥ en ambos m√©todos
    echo üö® CR√çTICO: Sin F5-TTS el sistema NO funcionar√°
    set /a FAIL_COUNT+=1
)

:: Limpiar archivos temporales F5-TTS
:f5_tts_failed
if exist "temp_f5_tts" (
    echo üßπ Limpiando archivos temporales F5-TTS...
    rmdir /s /q "temp_f5_tts" 2>nul
)

:f5_tts_done

:: Instalar dependencias avanzadas de audio
echo.
echo [8/8] üé∂ Instalando dependencias avanzadas de audio...
python -m pip install librosa scipy --quiet
python -c "import librosa, scipy; print('AUDIO_ADVANCED_OK')" >nul 2>&1
if %ERRORLEVEL% equ 0 (
    echo ‚úÖ Librosa y SciPy instalados y funcionales
    set /a SUCCESS_COUNT+=1
) else (
    echo ‚ö†Ô∏è Algunas dependencias de audio fallaron
    echo    El sistema funcionar√° con funcionalidad b√°sica
    set /a FAIL_COUNT+=1
)

:: Resumen final con estad√≠sticas
echo.
echo ============================================================
echo üèÅ INSTALACI√ìN COMPLETADA
echo ============================================================
echo.
echo üìä ESTAD√çSTICAS:
echo    ‚úÖ Componentes exitosos: %SUCCESS_COUNT%
echo    ‚ùå Componentes fallidos: %FAIL_COUNT%

if %FAIL_COUNT% equ 0 (
    echo.
    echo üéâ ¬°INSTALACI√ìN PERFECTA!
    echo ========================
    echo Todos los componentes se instalaron correctamente.
    echo El sistema est√° completamente funcional.
) else if %SUCCESS_COUNT% gtr %FAIL_COUNT% (
    echo.
    echo ‚úÖ INSTALACI√ìN MAYORMENTE EXITOSA
    echo =================================
    echo La mayor√≠a de componentes funcionan.
    echo Algunos componentes opcionales fallaron pero el sistema es usable.
) else (
    echo.
    echo ‚ö†Ô∏è INSTALACI√ìN PARCIAL
    echo ======================
    echo Varios componentes fallaron.
    echo El sistema tiene funcionalidad limitada.
)

echo.
echo üß™ Para verificar qu√© funciona:
echo    python -c "import f5_tts; print('‚úÖ F5-TTS funcionando')"
echo    python -c "import torch; print('‚úÖ PyTorch funcionando')"
echo    python -c "import gradio; print('‚úÖ Gradio funcionando')"
echo.
echo üöÄ Para usar las aplicaciones:
echo    python gradio_tts_app.py
echo    python gradio_vc_app.py
echo.
echo üîß Si hay problemas, revisa:
echo    - Python 3.11.8 instalado para m√°xima compatibilidad?
echo    - F5-TTS instalado correctamente? (CR√çTICO)
echo    - Visual Studio Build Tools instalados?
echo    - NVIDIA GPU con drivers actualizados?
echo    - CUDA Toolkit 12.1 instalado?
echo    - Conexi√≥n a internet estable?
echo.
echo üí° COMPONENTES CR√çTICOS PARA FUNCIONAMIENTO:
echo    üéØ F5-TTS: Motor principal de text-to-speech
echo    üî• PyTorch: Aceleraci√≥n GPU/CPU
echo    üñ•Ô∏è Gradio: Interfaz web
echo.
echo üö® SIN F5-TTS EL SISTEMA NO FUNCIONAR√Å
echo    - Visual Studio Build Tools instalados?
echo    - NVIDIA GPU con drivers actualizados?
echo    - CUDA Toolkit 12.1 instalado?
echo    - Conexi√≥n a internet estable?
echo.
echo üí° RECOMENDACIONES PARA M√ÅXIMO RENDIMIENTO:
echo    üêç Python 3.11: https://www.python.org/downloads/release/python-3118/
echo    üîß Visual Studio Build Tools: https://visualstudio.microsoft.com/visual-cpp-build-tools/
echo    üéÆ CUDA Toolkit 12.1: https://developer.nvidia.com/cuda-12-1-0-download-archive
echo    üì± Drivers NVIDIA: https://www.nvidia.com/drivers/
echo.
if "%PYTHON_MINOR%"=="11" (
    echo ‚úÖ CONFIGURACI√ìN √ìPTIMA: Python 3.11 detectado
) else (
    echo ‚ö†Ô∏è MEJORA RECOMENDADA: Considera actualizar a Python 3.11
)
echo.
pause
exit /b 0
